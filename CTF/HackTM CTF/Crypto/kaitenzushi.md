# kaitenzushi

[é¢˜ç›®](https://github.com/y011d4/my-ctf-challenges/tree/main/2023-HackTMCTF-2023/crypto/kaitenzushi)

å‘ç°äº†ä¸€ä¸ªå¾ˆå¥½ç†è§£çš„[wp](https://github.com/Neobeo/HackTM2023/blob/main/crypto_quals.ipynb)ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚

```python
from math import gcd
from Crypto.Util.number import bytes_to_long, isPrime

from secret import p, q, x1, y1, x2, y2, e, flag

# properties of secret variables
assert isPrime(p) and p.bit_length() == 768
assert isPrime(q) and q.bit_length() == 768
assert isPrime(e) and e.bit_length() == 256
assert gcd((p - 1) * (q - 1), e) == 1
assert x1.bit_length() <= 768 and x2.bit_length() <= 768
assert y1.bit_length() <= 640 and y2.bit_length() <= 640
assert x1 ** 2 + e * y1 ** 2 == p * q
assert x2 ** 2 + e * y2 ** 2 == p * q

# encrypt flag by RSA, with xor
n = p * q
c = pow(bytes_to_long(flag) ^^ x1 ^^ y1 ^^ x2 ^^ y2, e, n)
print(f"{n = }")
print(f"{c = }")


# hints ğŸ£
F = RealField(1337)
x = vector(F, [x1, x2])
y = vector(F, [y1, y2])
# rotate
theta = F.random_element(min=-pi, max=pi)
R = matrix(F, [[cos(theta), -sin(theta)], [sin(theta), cos(theta)]])
x = R * x
y = R * y
print(f"{x = }")
print(f"{y = }")
```

rsaï¼Œä½†æ˜¯å¯†æ–‡æ˜¯ç»è¿‡å¼‚æˆ–åçš„flagçš„åŠ å¯†ç»“æœï¼Œä¸”eæœªçŸ¥ã€‚x1ï¼Œx2ï¼Œy1ï¼Œy2ç»„æˆå‘é‡åç»•æœªçŸ¥è§’åº¦thetaé€†æ—¶é’ˆ[æ—‹è½¬](https://zhuanlan.zhihu.com/p/98007510)åè¾“å‡ºã€‚è„šæœ¬é‡Œçš„çŸ©é˜µRæ˜¯å®æ•°åŸŸ[RealField](https://doc.sagemath.org/html/en/reference/rings_numerical/sage/rings/real_mpfr.html#sage.rings.real_mpfr.RealField)Fä¸Šçš„ï¼Œå…¶ä¸­Fçš„ç²¾åº¦è¾¾åˆ°äº†1337ä½ã€‚

å…ˆå°è¯•æ‰¾åˆ°eã€‚ä¸éš¾ï¼Œå› ä¸ºæœ€å¼€å§‹çš„assertå·²ç»å‘Šè¯‰äº†æˆ‘ä»¬x1ï¼Œy1å’Œeçš„å…³ç³»ï¼ŒåŠ ä¸Šæ—‹è½¬ä¸ä¼šæ”¹å˜å‘é‡çš„[èŒƒæ•°](https://zhuanlan.zhihu.com/p/67120415)ï¼ˆè¿™é‡Œå¯ç®€å•ç†è§£ä¸ºå‘é‡çš„é•¿åº¦ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å®Œå…¨å¯ä»¥ç›´æ¥æ ¹æ®è·å¾—çš„xå‘é‡å’Œyå‘é‡ç®—å‡ºeã€‚

```python
F = RealField(1337)
n = 990853953648382437503731888872568785013804329239290721076418541795771569507440261620612308640652961121590348037236708702361580700250705591203587939980126323233833431892076634892318387020242015741789265095380967467201291693288654956012435416445991341222221539511583706970342630678909437274145759598920314784293470918464283814408418704426938549136143925649863711450268227592032494660523680280136089617838412326902639568680941504799777445608524961048789627301462833
c = 312168688094168684887530746663711142224819184527420449851136749248641895825646649162310024737395663075921549510262779965673286770730468773215063305158197748549937395602308558217528064655976647148323981103647078862713773074121667862786737690376212246588956833193632937835958166526006128435536115531865213269197137648990987207140262543956087199861542889002996727146832659889656384027201202873352819689303456895088190857667281342371263570535523695457095802010885279
x = vector([F('9.93659400123277470926327676478883140697376509010297766512845139881487348637477791719517951397052010880811619509960535668814993293095146708957649613776125686226138447162258666762024346093786649228730054881453449071976210130217897905782845690384638460560301964009359233596889465133986468021963885911072779457835979983964294586954038412718305000570678333513135467257498071686562749882446495426493483289204e230'), F('-1.20540611958254673086539287012513674064476659427085664430224592760592531301348857885707154893714440960111029743010026152632150988429192286517249118913535366887447596463819555191858702861383725310592687577510708180057642425944345656558038998574368521689142109798891989865473206201635908814994474491537093810680632691594902962470061189337645818851446622588020765058461348047229165216450857822980873846637e230')])
y = vector([F('9.02899744041999015549480362358897037217795303901085937071039171882835297563545959015336648016772002396355451308252077767567617065937943765701645833054147976124287566465577491039263554806622908070370269238064956822205986576949383035741108310668397305286076364909407660314991847716094610949669608550117248147017329449889127749721988228613503029640191269319151291514601769696635252288607881829734506023770e191'), F('2.82245306887391321716872765000993510002376761684498801971981175059452895101888694909625866715259620501905532121092041448909218372087306882364769769589919830746245167403566884491547911250261820661981772195356239940907493773024918284094309809964348965190219508641693641202225028173892050377939993484981988687903270349415531065381420872722271855270893103191849754016799925873189392548972340802542077635974e192')])
# Step 1: Solve for e
e = int((2*n-x.norm()**2)/y.norm()**2)
f'{e=}'
#'e=111578009802636409437123757591617048189760145423552421418627338749835916561801'
```

æ¥ä¸‹æ¥æ˜¯æ‰¾åˆ°æ—‹è½¬å‰çš„xå’Œyã€‚æ€è€ƒä¸€ä¸‹ï¼Œé¢˜ç›®å†æ€ä¹ˆæ—‹è½¬ï¼Œå¼§åº¦éƒ½æ˜¯åœ¨0-1å†…ï¼Œè¶…è¿‡åå°±ç»•å›æ¥äº†ã€‚å¦‚æœå¼§åº¦æ˜¯0ï¼Œ $x^2+ey^2$ å°äºnï¼›å¦‚æœå¼§åº¦æ˜¯1ï¼Œ $x^2+ey^2$ ç­‰äºnã€‚åªæœ‰æ­£ç¡®çš„å€¼ä¿è¯ $x^2+ey^2=n$ ã€‚åŸºäºæ­¤ï¼Œå°±èƒ½ä½¿ç”¨äºŒåˆ†æ³•çˆ†ç ´å‡ºåŸæ¥çš„xå’Œyã€‚

```python
#Step 2: Solve for x1, x2, y1, y2
def get(theta):
    R = matrix(F, [[cos(theta), -sin(theta)], [sin(theta), cos(theta)]])
    xx = R * x
    yy = R * y
    xx = [int(z + F(1/2)) for z in xx] #è¿™é‡Œæˆ‘å‘ç°å¦‚æœä¸åŠ F(1/2)ï¼Œç›´æ¥è½¬intç»“æœå’ŒåŠ ä¸ŠF(1/2)åçš„ç»“æœå¯èƒ½ä¸€æ ·ï¼Œä¹Ÿå¯èƒ½å·®ä¸ªå¾ˆå°çš„å€¼ã€‚
    yy = [int(z + F(1/2)) for z in yy] #è€Œä¸”å¾ˆç¥å¥‡çš„ä¸€ç‚¹æ˜¯ï¼Œå‡è®¾xx[0]=1.348382...,int(xx[0])=1348382ï¼Œä¸çŸ¥é“ä¸ºå•¥å˜è¿™ä¹ˆå¤§
    t0 = xx[0]**2 + e*yy[0]**2
    t1 = xx[1]**2 + e*yy[1]**2
    return t1, xx, yy

lo, hi = F(0), F(1)
assert get(lo)[0]<n
assert get(hi)[0]>n
for _ in range(2000):
    mid = (lo+hi)/2
    g, xx, yy = get(mid)
    if g == n:
        break
    elif g > n:
        hi = mid
    else:
        lo = mid

x1, x2 = xx
y1, y2 = yy
assert x1**2 + e*y1**2 == n
assert x2**2 + e*y2**2 == n
x1, x2, y1, y2
```

ç¬¬ä¸‰æ­¥æˆ‘ä»¬è¿˜åŸpå’Œqã€‚è¿˜æ˜¯`assert x1 ** 2 + e * y1 ** 2 == p * q`å’Œ`assert x2 ** 2 + e * y2 ** 2 == p * q`è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬å˜å½¢ä¸€ä¸‹ã€‚

$x_1^2+ey_1^2=x_2^2+ey_2^2=p\*q$<br>
$e=\frac{-x_1^2}{y_1^2}=\frac{-x_2^2}{y_2^2}=p\*q=n$<br>
$\frac{-x_1^2}{y_1^2}-\frac{-x_2^2}{y_2^2}=n$<br>
$\frac{-x_1^2}{y_1^2}+\frac{x_2^2}{y_2^2}=n$<br>
$(\frac{x_2}{y_2})^2-(\frac{x_1}{y_1})^2=n$<br>
$\left(\frac{x_2}{y_2}+\frac{x_1}{y_1}\right)\left(\frac{x_2}{y_2}-\frac{x_1}{y_1}\right)=n$

ï¼ˆæˆ‘è¿™é‡Œå¾—å‡ºæ¥çš„ç»“æœå’Œwpçš„ä¸ä¸€æ ·ï¼Œå¯èƒ½ä¸¤è€…æ˜¯ç›¸ç­‰çš„è¿˜æ˜¯æˆ‘ç®—é”™äº†ï¼Ÿï¼‰

$\left(\frac{x_2}{y_2}-\frac{x_1}{y_1}\right)\not ={p,q}$ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½å°è¯•ç”¨gcdæ‰¾å‡ºpå’Œqã€‚

```python
p = int(gcd(n, x1*y2-x2*y1)) #ç”¨æˆ‘ç®—å‡ºæ¥çš„p = int(gcd(n, x2*y1-x1*y2))ä¹Ÿè¡Œï¼Œæˆ–è€…ç”¨å¦ä¸€ä¸ªå¼å­p = int(gcd(n, x2*y1+x1*y2))ä¹Ÿè¡Œ
q = n // p
assert 1 < p < n and n == p * q

d = pow(e, -1, (p-1)*(q-1))
long_to_bytes(pow(c, d, n) ^ x1 ^ x2 ^ y1 ^ y2)
```

è¿™é‡Œçš„gcdç›´æ¥äº¤å‰ç›¸ä¹˜ï¼Œæ²¡æœ‰é™¤å»åˆ†æ¯ $y_2y_1$ ã€‚è¿™æ˜¯å› ä¸º`x1*y2-x2*y1`è‚¯å®šæ¯”pæˆ–è€…qå¤§ï¼Œé™¤å» $y_2y_1$ å°±ä¸ä¸€å®šäº†ã€‚æˆ‘ä»¬çŸ¥é“pæˆ–è€…qæ˜¯è´¨æ•°ï¼Œ $y_2y_1$ æ˜¯æ•´æ•°ï¼Œé‚£`x1*y2-x2*y1`ä¸pæˆ–è€…qçš„gcdä¸€å®šæ˜¯pæˆ–è€…qã€‚

## Flag
> HackTM{r07473_pr353rv35_50m37h1n6}